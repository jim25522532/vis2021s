<!DOCTYPE html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="utf-8">
    <title>D3 Page Template</title>
    <script src="http://d3js.org/d3.v4.min.js" charset="utf-8"></script> <!-- v6.5.0 -->
    <meta charset="utf-8">
</head>
<body>
    <div id="srt"></div>
    <script type="text/javascript">
      
      var myarray = [];
      var key;
      var begin;
      var end;
      var subtitle;
      var width=960;
      var height = 540;

      d3.text('DAOKO.srt',(data)=>{
        console.log(data);

        parsedCSV = d3.csvParseRows(data);
        console.log(parsedCSV);
        
        d3.select('#srt')
          .selectAll('p')
          .data(parsedCSV)
          .enter()
          .append("p")
          .text((d,i)=>{
            if( !isNaN(d) && d!=''){
              key = +d-1;
            }
            else if(d ==""){
              myarray.push({
                "key" : key,
                "begin" : begin,
                "end" : end ,
                "dur" : end-begin , 
                "subtitle" : subtitle 
              });
            }
            //時間(,)隔開陣列長度剛好長度3
            else if(d.length==3){

              begin = (parseInt(d[0][3]) * 10 + parseInt(d[0][4])) * 60 + 
              (parseInt(d[0][6]) * 10 + parseInt(d[0][6]));

              end = (parseInt(d[1][11]) * 10 + parseInt(d[1][12])) * 60 + 
              (parseInt(d[1][14]) * 10 + parseInt(d[1][15]));
            }
            else{
              subtitle = d;
            }
            
          })
          //完成歌詞
          console.log("myarray" + myarray);

         
          
      d3.select("body")
          .append("svg")
          .attr("width",width)
          .attr("height",height)
          .attr("viewBox",()=>{
            return "0 , 0 " + width +"," + height;
          })
          .append("rect")
          .attr("x","0")
          .attr("y","0")
          .attr("width",width)
          .attr("height",height)
          .attr("fill","none")
          .attr("stroke","red")


      d3.selectAll("text")
          .data(myarray)
          .enter()
          .append("text")
          .text(function(d , i){
              return d.subtitle;
          })
          .attr('font-size','66pt')
          .attr('fill','black')
          .attr("stroke", "blue")
          .attr("x", width / 2)
          .attr("y" , height - 50)
          .attr("text-anchor","middle")
          //MS PGothic 微軟正黑體
          .style("font-family","MS PGothic")
          .attr("opacity",0)
          .transition()
          .delay(function(d){
            return (d.begin - d.dur /4) *100;
          })
          .duration(function(d){
            return d.dur * 1000;
          })
          .attr("opacity",1)
          ;
      })

     

    </script>
  </body>
</html>
  